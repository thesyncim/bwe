---
phase: 06-test-infrastructure-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/bwe/testutil/browser.go
  - go.mod
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Tests can create a headless Chrome instance with WebRTC capabilities"
    - "Browser can navigate to URLs with configurable timeout"
    - "Browser resources are cleaned up on Close()"
    - "Chrome launches with fake media flags for permission-free WebRTC"
  artifacts:
    - path: "pkg/bwe/testutil/browser.go"
      provides: "BrowserClient type wrapping Rod for WebRTC testing"
      exports: ["BrowserClient", "NewBrowserClient", "BrowserConfig"]
    - path: "go.mod"
      provides: "Rod dependency"
      contains: "github.com/go-rod/rod"
  key_links:
    - from: "pkg/bwe/testutil/browser.go"
      to: "github.com/go-rod/rod"
      via: "import and launcher.New()"
      pattern: "rod\\.New|launcher\\.New"
---

<objective>
Create BrowserClient wrapper for WebRTC-ready headless Chrome automation

Purpose: Provide E2E tests with a simple API to launch Chrome, navigate to URLs, and execute JavaScript for WebRTC testing
Output: pkg/bwe/testutil/browser.go with BrowserClient type wrapping Rod v0.116.2
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-test-infrastructure-foundation/06-RESEARCH.md

# Existing testutil package for pattern reference
@pkg/bwe/testutil/traces.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Rod dependency</name>
  <files>
    go.mod
  </files>
  <action>
Add Rod v0.116.2 to the project:

```bash
go get github.com/go-rod/rod@v0.116.2
```

This will update go.mod and go.sum with the Rod dependency and its transitive dependencies.

Rod provides:
- Chrome DevTools Protocol (CDP) driver
- Auto-downloads Chromium if not present
- Thread-safe browser automation
- Leakless subprocess cleanup
  </action>
  <verify>
`go mod tidy && grep "go-rod/rod" go.mod` shows v0.116.2
  </verify>
  <done>
Rod v0.116.2 added to go.mod
  </done>
</task>

<task type="auto">
  <name>Task 2: Create BrowserClient type</name>
  <files>
    pkg/bwe/testutil/browser.go
  </files>
  <action>
Create `pkg/bwe/testutil/browser.go` with BrowserClient wrapper.

1. Package header matching existing testutil style:
```go
// browser.go provides browser automation utilities for E2E testing.
// It wraps Rod to provide WebRTC-ready Chrome instances.
package testutil
```

2. BrowserConfig struct:
```go
// BrowserConfig configures Chrome launch options.
type BrowserConfig struct {
    Headless bool          // Run in headless mode (default: true)
    Timeout  time.Duration // Default operation timeout (default: 30s)
}

// DefaultBrowserConfig returns sensible defaults for E2E testing.
func DefaultBrowserConfig() BrowserConfig {
    return BrowserConfig{
        Headless: true,
        Timeout:  30 * time.Second,
    }
}
```

3. BrowserClient struct:
```go
// BrowserClient wraps Rod with WebRTC-ready Chrome configuration.
type BrowserClient struct {
    browser *rod.Browser
    page    *rod.Page
    timeout time.Duration
}
```

4. NewBrowserClient function:
```go
// NewBrowserClient creates a headless Chrome with WebRTC flags.
// The browser is configured with:
// - Fake media streams (no real camera/mic required)
// - Auto-granted media permissions
// - No sandbox (for container compatibility)
// - Autoplay without user gesture
func NewBrowserClient(cfg BrowserConfig) (*BrowserClient, error) {
    l := launcher.New().
        Headless(cfg.Headless).
        Set("no-sandbox").
        Set("disable-gpu").
        Set("use-fake-device-for-media-stream").
        Set("use-fake-ui-for-media-stream").
        Set("autoplay-policy", "no-user-gesture-required")

    url, err := l.Launch()
    if err != nil {
        return nil, fmt.Errorf("failed to launch Chrome: %w", err)
    }

    browser := rod.New().ControlURL(url)
    if err := browser.Connect(); err != nil {
        return nil, fmt.Errorf("failed to connect to Chrome: %w", err)
    }

    return &BrowserClient{
        browser: browser,
        timeout: cfg.Timeout,
    }, nil
}
```

5. Methods:
```go
// Navigate opens a URL with timeout.
// Returns the page for further interaction.
func (c *BrowserClient) Navigate(url string) (*rod.Page, error) {
    page := c.browser.MustPage()
    c.page = page

    err := page.Timeout(c.timeout).Navigate(url)
    if err != nil {
        return nil, fmt.Errorf("failed to navigate to %s: %w", url, err)
    }

    // Cancel timeout so Close() works
    page.CancelTimeout()
    return page, nil
}

// Page returns the current page, or nil if none open.
func (c *BrowserClient) Page() *rod.Page {
    return c.page
}

// Eval executes JavaScript and returns the result.
// Requires Navigate() to have been called first.
func (c *BrowserClient) Eval(js string) (interface{}, error) {
    if c.page == nil {
        return nil, errors.New("no page open, call Navigate first")
    }
    result, err := c.page.Eval(js)
    if err != nil {
        return nil, fmt.Errorf("eval failed: %w", err)
    }
    return result.Value, nil
}

// WaitStable waits for the page to be stable (no DOM changes).
func (c *BrowserClient) WaitStable() error {
    if c.page == nil {
        return errors.New("no page open")
    }
    return c.page.WaitStable(c.timeout)
}

// Close cleans up browser resources.
// Always call this (via defer) to prevent orphaned Chrome processes.
func (c *BrowserClient) Close() error {
    if c.browser != nil {
        return c.browser.Close()
    }
    return nil
}
```

6. Import block:
```go
import (
    "errors"
    "fmt"
    "time"

    "github.com/go-rod/rod"
    "github.com/go-rod/rod/lib/launcher"
)
```

Critical WebRTC flags (from research):
- `use-fake-device-for-media-stream`: Provides synthetic video/audio without real devices
- `use-fake-ui-for-media-stream`: Bypasses permission prompts
- `no-sandbox`: Required in containers/CI
- `autoplay-policy=no-user-gesture-required`: Allows media to play automatically
  </action>
  <verify>
`go build ./pkg/bwe/testutil/` compiles without errors
  </verify>
  <done>
BrowserClient type exists with NewBrowserClient, Navigate, Eval, WaitStable, Close methods. Package compiles with Rod dependency.
  </done>
</task>

</tasks>

<verification>
1. Package compiles: `go build ./pkg/bwe/testutil/`
2. Rod in go.mod: `grep "go-rod/rod" go.mod` shows v0.116.2
3. Quick functional test (manual): Create temp test file that calls NewBrowserClient and Close
</verification>

<success_criteria>
1. `pkg/bwe/testutil/browser.go` exports BrowserClient, BrowserConfig, NewBrowserClient, DefaultBrowserConfig
2. NewBrowserClient launches Chrome with WebRTC flags (fake media, no sandbox)
3. Navigate() opens URLs with configurable timeout
4. Close() cleans up browser resources
5. Package compiles and imports Rod v0.116.2
</success_criteria>

<output>
After completion, create `.planning/phases/06-test-infrastructure-foundation/06-02-SUMMARY.md`
</output>
