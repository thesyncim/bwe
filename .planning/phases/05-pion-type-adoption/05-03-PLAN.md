---
phase: 05-pion-type-adoption
plan: 03
type: execute
wave: 3
depends_on: [05-01, 05-02]
files_modified: []
autonomous: true

must_haves:
  truths:
    - "All existing tests pass without modification (VAL-01)"
    - "Benchmark suite shows 0 allocs/op for core estimator (VAL-02)"
    - "24-hour accelerated soak test passes with 1350+ wraparounds (VAL-03)"
    - "FindExtensionID helpers remain unchanged in interceptor/extension.go (KEEP-02)"
    - "Inter-group delay calculation remains unchanged (KEEP-03)"
  artifacts:
    - path: "pkg/bwe/interceptor/extension.go"
      provides: "FindExtensionID helpers preserved"
      contains: "FindExtensionID"
    - path: "pkg/bwe/interarrival.go"
      provides: "Inter-group delay calculation preserved"
      contains: "ComputeInterGroupDelays"
  key_links:
    - from: "pkg/bwe/interceptor/interceptor.go"
      to: "pkg/bwe/interceptor/extension.go"
      via: "FindAbsSendTimeID/FindAbsCaptureTimeID calls"
      pattern: "Find.*ID"
---

<objective>
Run full validation suite to verify no behavioral or performance regressions

Purpose: Confirm v1.1 refactoring preserves v1.0 validated behavior (VAL-01 through VAL-04) and critical logic (KEEP-01 through KEEP-03)
Output: All validation tests pass; verification evidence documented
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-pion-type-adoption/05-RESEARCH.md
@.planning/phases/05-pion-type-adoption/05-01-SUMMARY.md
@.planning/phases/05-pion-type-adoption/05-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run full test suite (VAL-01)</name>
  <files></files>
  <action>
Run the complete test suite across all packages to verify behavioral equivalence.

Execute:
```bash
go test ./... -v -count=1
```

ALL tests must pass. This validates VAL-01: "All existing tests pass without modification (behavioral equivalence verified)"

Key test areas to watch:
- pkg/bwe/timestamp_test.go - timestamp parsing and wraparound
- pkg/bwe/interceptor/... - processRTP with Pion extension types
- pkg/bwe/soak_test.go - long-running behavior
- All Phase 1-4 tests

If any test fails, stop and investigate - the refactoring should be transparent to existing tests.
  </action>
  <verify>
Run: `go test ./... -v -count=1 2>&1 | tail -20`
Should show "ok" for all packages, no failures
  </verify>
  <done>All existing tests pass without modification (VAL-01 verified)</done>
</task>

<task type="auto">
  <name>Task 2: Run allocation benchmarks (VAL-02)</name>
  <files></files>
  <action>
Run the benchmark suite to verify 0 allocs/op for core estimator is maintained.

Execute core estimator benchmarks:
```bash
go test -bench=ZeroAlloc -benchmem ./pkg/bwe/...
```

Expected results:
- BenchmarkBandwidthEstimator_OnPacket_ZeroAlloc: 0 allocs/op
- BenchmarkDelayEstimator_OnPacket_ZeroAlloc: 0 allocs/op
- All other ZeroAlloc benchmarks: 0 allocs/op

Execute interceptor benchmarks:
```bash
go test -bench=. -benchmem ./pkg/bwe/interceptor/...
```

Expected results:
- BenchmarkProcessRTP_Allocations: 2 allocs/op (acceptable - atomic.Value + sync.Map)
- BenchmarkPacketInfoPool_GetPut: 0 allocs/op

CRITICAL: If core estimator shows >0 allocs/op, the refactoring introduced a regression. Debug with:
```bash
go build -gcflags="-m" ./pkg/bwe/interceptor 2>&1 | grep -E "(escapes|moved to heap)"
```

The Pion extension parsing in processRTP MUST use stack-allocated structs (`var ext rtp.AbsSendTimeExtension`) to avoid heap allocations.
  </action>
  <verify>
Run: `go test -bench=BandwidthEstimator_OnPacket_ZeroAlloc -benchmem ./pkg/bwe/... 2>&1 | grep allocs`
Should show "0 allocs/op"
  </verify>
  <done>Benchmark suite shows 0 allocs/op for core estimator (VAL-02 verified)</done>
</task>

<task type="auto">
  <name>Task 3: Run 24-hour accelerated soak test (VAL-03)</name>
  <files></files>
  <action>
Run the 24-hour accelerated soak test to verify timestamp wraparound handling is preserved.

Execute:
```bash
go test -run TestSoak24Hour_Accelerated ./pkg/bwe/... -v
```

This test:
- Simulates 24 hours of traffic (4.32M packets in ~1 second)
- Exercises 1350+ timestamp wraparounds at 64-second boundaries
- Verifies no NaN/Inf/panic
- Verifies memory stays bounded (<100MB)
- Verifies estimates remain reasonable (1 bps to 1 Gbps)

Expected output:
- "Total packets processed: 4320000"
- "Total wraparounds: 1349" (or similar, should be >1000)
- "PASS"

This validates that UnwrapAbsSendTime() (KEEP-01) continues to work correctly with the Pion-parsed timestamps.

If the soak test fails:
1. Check that the interceptor correctly casts uint32(ext.Timestamp)
2. Check that UnwrapAbsSendTime was NOT modified
3. Run shorter tests: `go test -run TestTimestampWraparound -v ./pkg/bwe/...`
  </action>
  <verify>
Run: `go test -run TestSoak24Hour_Accelerated ./pkg/bwe/... -v 2>&1 | tail -10`
Should show "PASS" and wraparound count >1000
  </verify>
  <done>24-hour accelerated soak test passes with 1350+ wraparounds (VAL-03 verified)</done>
</task>

<task type="auto">
  <name>Task 4: Verify KEEP requirements preserved</name>
  <files></files>
  <action>
Verify that critical logic identified in KEEP requirements was not modified.

KEEP-01: UnwrapAbsSendTime unchanged
```bash
grep -A10 "^func UnwrapAbsSendTime" pkg/bwe/timestamp.go
```
Should show unchanged function body with half-range comparison logic.

KEEP-02: FindExtensionID helpers unchanged
```bash
grep -A5 "^func FindExtensionID" pkg/bwe/interceptor/extension.go
grep -A5 "^func FindAbsSendTimeID" pkg/bwe/interceptor/extension.go
grep -A5 "^func FindAbsCaptureTimeID" pkg/bwe/interceptor/extension.go
```
All three functions should exist unchanged.

KEEP-03: Inter-group delay calculation unchanged
```bash
grep -A10 "ComputeInterGroupDelays" pkg/bwe/interarrival.go
```
Should show unchanged method computing delta_send and delta_recv.

These are verification checks only - no code modifications. If any KEEP function was inadvertently modified, flag it as a blocker for the phase.
  </action>
  <verify>
Run all three grep commands above.
Each should return non-empty output showing the preserved functions.
  </verify>
  <done>All KEEP requirements verified: UnwrapAbsSendTime (KEEP-01), FindExtensionID (KEEP-02), inter-group delay (KEEP-03)</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `go test ./... -count=1` exits with code 0 (VAL-01)
2. `go test -bench=ZeroAlloc -benchmem ./pkg/bwe/...` shows 0 allocs/op (VAL-02)
3. TestSoak24Hour_Accelerated passes with 1350+ wraparounds (VAL-03)
4. KEEP-01, KEEP-02, KEEP-03 functions are unchanged

VAL-04 (Chrome interop) note: This requires manual verification with a Chrome browser.
The automated tests cannot fully verify Chrome interop. Document that VAL-04 should be
verified manually using `go run ./cmd/chrome-interop` and checking chrome://webrtc-internals.
</verification>

<success_criteria>
- VAL-01: All existing tests pass (`go test ./...` exits 0)
- VAL-02: Core estimator maintains 0 allocs/op
- VAL-03: 24-hour soak test passes with proper wraparound handling
- KEEP-01: UnwrapAbsSendTime unchanged
- KEEP-02: FindExtensionID helpers unchanged
- KEEP-03: Inter-group delay calculation unchanged
- VAL-04: Chrome interop documented as requiring manual verification
</success_criteria>

<output>
After completion, create `.planning/phases/05-pion-type-adoption/05-03-SUMMARY.md`

Include a requirements verification table:

| Requirement | Status | Evidence |
|-------------|--------|----------|
| VAL-01 | PASS/FAIL | go test ./... output |
| VAL-02 | PASS/FAIL | 0 allocs/op benchmark |
| VAL-03 | PASS/FAIL | Soak test wraparound count |
| VAL-04 | MANUAL | Chrome interop requires browser |
| KEEP-01 | PASS/FAIL | grep output |
| KEEP-02 | PASS/FAIL | grep output |
| KEEP-03 | PASS/FAIL | grep output |
</output>
