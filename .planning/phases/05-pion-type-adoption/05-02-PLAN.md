---
phase: 05-pion-type-adoption
plan: 02
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - pkg/bwe/timestamp.go
  - pkg/bwe/timestamp_test.go
autonomous: true

must_haves:
  truths:
    - "ParseAbsSendTime() has deprecation comment pointing to pion/rtp.AbsSendTimeExtension"
    - "ParseAbsCaptureTime() has deprecation comment pointing to pion/rtp.AbsCaptureTimeExtension"
    - "Deprecation comments specify removal in v1.2"
    - "All existing timestamp tests still pass"
    - "UnwrapAbsSendTime() is unchanged (KEEP-01)"
    - "Duration conversion helpers are unchanged"
  artifacts:
    - path: "pkg/bwe/timestamp.go"
      provides: "Deprecated parse functions with removal timeline"
      contains: "Deprecated:"
  key_links:
    - from: "pkg/bwe/timestamp.go"
      to: "pion/rtp"
      via: "deprecation comment reference"
      pattern: "rtp\\.AbsSendTimeExtension"
---

<objective>
Mark custom parsing functions as deprecated with clear migration path

Purpose: Signal to callers that ParseAbsSendTime() and ParseAbsCaptureTime() should migrate to Pion extension types (EXT-03, EXT-04)
Output: timestamp.go with deprecation comments; all existing tests pass
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-pion-type-adoption/05-RESEARCH.md
@pkg/bwe/timestamp.go
@pkg/bwe/timestamp_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add deprecation comment to ParseAbsSendTime</name>
  <files>pkg/bwe/timestamp.go</files>
  <action>
Add a deprecation comment to ParseAbsSendTime function. The comment must:
1. Start with "Deprecated:" (Go convention for godoc)
2. Reference the Pion replacement: rtp.AbsSendTimeExtension.Unmarshal()
3. Specify removal timeline: v1.2
4. Explain why (maintained upstream, battle-tested)

CURRENT CODE (lines ~12-21):
```go
// ParseAbsSendTime parses a 24-bit abs-send-time value from a 3-byte big-endian
// representation. This is the format used in the RTP header extension.
//
// The abs-send-time extension uses 24 bits in 6.18 fixed-point format,
// representing NTP time modulo 64 seconds.
func ParseAbsSendTime(data []byte) (uint32, error) {
```

REPLACE WITH:
```go
// ParseAbsSendTime parses a 24-bit abs-send-time value from a 3-byte big-endian
// representation. This is the format used in the RTP header extension.
//
// The abs-send-time extension uses 24 bits in 6.18 fixed-point format,
// representing NTP time modulo 64 seconds.
//
// Deprecated: Use rtp.AbsSendTimeExtension.Unmarshal() from github.com/pion/rtp instead.
// This function will be removed in v1.2. The Pion implementation is maintained upstream
// and handles validation. Example migration:
//
//	var ext rtp.AbsSendTimeExtension
//	if err := ext.Unmarshal(data); err == nil {
//	    sendTime = uint32(ext.Timestamp)
//	}
func ParseAbsSendTime(data []byte) (uint32, error) {
```

DO NOT change the function implementation - only add the deprecation comment.
  </action>
  <verify>
Run: `go build ./pkg/bwe/...`
Should compile without errors
  </verify>
  <done>ParseAbsSendTime has deprecation comment with migration example</done>
</task>

<task type="auto">
  <name>Task 2: Add deprecation comment to ParseAbsCaptureTime</name>
  <files>pkg/bwe/timestamp.go</files>
  <action>
Add a deprecation comment to ParseAbsCaptureTime function. Same pattern as Task 1.

CURRENT CODE (lines ~85-98):
```go
// ParseAbsCaptureTime parses a 64-bit abs-capture-time value from an 8-byte
// big-endian representation. This is the UQ32.32 format where the upper 32 bits
// are seconds and the lower 32 bits are fractions of a second.
//
// The abs-capture-time extension uses 64 bits, providing ~136 years of range
// with sub-nanosecond precision.
func ParseAbsCaptureTime(data []byte) (uint64, error) {
```

REPLACE WITH:
```go
// ParseAbsCaptureTime parses a 64-bit abs-capture-time value from an 8-byte
// big-endian representation. This is the UQ32.32 format where the upper 32 bits
// are seconds and the lower 32 bits are fractions of a second.
//
// The abs-capture-time extension uses 64 bits, providing ~136 years of range
// with sub-nanosecond precision.
//
// Deprecated: Use rtp.AbsCaptureTimeExtension.Unmarshal() from github.com/pion/rtp instead.
// This function will be removed in v1.2. The Pion implementation is maintained upstream
// and handles both 8-byte and 16-byte payloads (with optional clock offset). Example migration:
//
//	var ext rtp.AbsCaptureTimeExtension
//	if err := ext.Unmarshal(data); err == nil {
//	    captureTime = ext.Timestamp
//	}
func ParseAbsCaptureTime(data []byte) (uint64, error) {
```

DO NOT change the function implementation - only add the deprecation comment.
  </action>
  <verify>
Run: `go build ./pkg/bwe/...`
Should compile without errors
  </verify>
  <done>ParseAbsCaptureTime has deprecation comment with migration example</done>
</task>

<task type="auto">
  <name>Task 3: Verify all timestamp tests pass and KEEP requirements preserved</name>
  <files>pkg/bwe/timestamp.go, pkg/bwe/timestamp_test.go</files>
  <action>
Run the full timestamp test suite to verify:
1. All existing tests pass (deprecation comments don't break anything)
2. UnwrapAbsSendTime() is unchanged (KEEP-01)
3. Duration conversion helpers work correctly

Also verify by code inspection:
- UnwrapAbsSendTime() has NO changes (critical for timestamp wraparound handling)
- UnwrapAbsSendTimeDuration() has NO changes
- AbsSendTimeToDuration() has NO changes
- UnwrapAbsCaptureTime() has NO changes
- UnwrapAbsCaptureTimeDuration() has NO changes
- AbsCaptureTimeToDuration() has NO changes

These are KEEP requirements - the deprecation only applies to the raw parsing functions, NOT the wraparound logic or duration converters.
  </action>
  <verify>
Run: `go test ./pkg/bwe/... -run Timestamp -v`
All timestamp tests should pass

Run: `grep -A5 "^func UnwrapAbsSendTime" pkg/bwe/timestamp.go`
Should show unchanged function signature and first lines
  </verify>
  <done>All timestamp tests pass; UnwrapAbsSendTime and other KEEP functions remain unchanged</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `go build ./pkg/bwe/...` - compiles without errors
2. `go test ./pkg/bwe/... -run Timestamp -v` - all timestamp tests pass
3. `go doc bwe.ParseAbsSendTime` - shows "Deprecated:" in output
4. `go doc bwe.ParseAbsCaptureTime` - shows "Deprecated:" in output
5. Code review: UnwrapAbsSendTime has NO deprecation comment and NO changes
</verification>

<success_criteria>
- ParseAbsSendTime() has deprecation comment pointing to pion/rtp (EXT-03)
- ParseAbsCaptureTime() has deprecation comment pointing to pion/rtp (EXT-04)
- All existing timestamp tests pass
- UnwrapAbsSendTime() is preserved unchanged (KEEP-01)
- No functional changes to any code - comments only
</success_criteria>

<output>
After completion, create `.planning/phases/05-pion-type-adoption/05-02-SUMMARY.md`
</output>
