---
phase: 05-pion-type-adoption
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/bwe/interceptor/interceptor.go
autonomous: true

must_haves:
  truths:
    - "Pion rtp.AbsSendTimeExtension.Unmarshal() is used for abs-send-time parsing"
    - "Pion rtp.AbsCaptureTimeExtension.Unmarshal() is used for abs-capture-time parsing"
    - "Extension structs are stack-allocated to maintain 0 allocs/op"
    - "Existing behavior is preserved (same sendTime values produced)"
  artifacts:
    - path: "pkg/bwe/interceptor/interceptor.go"
      provides: "Pion extension parsing in processRTP hot path"
      contains: "rtp.AbsSendTimeExtension"
  key_links:
    - from: "pkg/bwe/interceptor/interceptor.go"
      to: "pion/rtp.AbsSendTimeExtension"
      via: "Unmarshal() method call"
      pattern: "ext\\.Unmarshal"
---

<objective>
Refactor interceptor processRTP to use Pion native extension types for parsing

Purpose: Replace custom byte-parsing with battle-tested Pion implementations while preserving zero-allocation hot path
Output: Modified interceptor.go using pion/rtp extension types
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-pion-type-adoption/05-RESEARCH.md
@pkg/bwe/interceptor/interceptor.go
@pkg/bwe/timestamp.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace ParseAbsSendTime with Pion Unmarshal</name>
  <files>pkg/bwe/interceptor/interceptor.go</files>
  <action>
In processRTP(), replace the abs-send-time parsing section:

CURRENT CODE (lines ~179-185):
```go
if absID != 0 {
    if ext := header.GetExtension(absID); len(ext) >= 3 {
        sendTime, _ = bwe.ParseAbsSendTime(ext)
    }
}
```

REPLACE WITH (stack-allocated struct for zero allocations):
```go
if absID != 0 {
    if extData := header.GetExtension(absID); len(extData) >= 3 {
        var ext rtp.AbsSendTimeExtension  // Stack allocated - CRITICAL for 0 allocs/op
        if err := ext.Unmarshal(extData); err == nil {
            sendTime = uint32(ext.Timestamp)  // Cast from uint64 to uint32 (24-bit fits)
        }
    }
}
```

CRITICAL: The `var ext rtp.AbsSendTimeExtension` MUST be declared on the stack (not via `new()`). The cast to uint32 is safe because abs-send-time is 24 bits (max 16777215).
  </action>
  <verify>
Run: `go build ./pkg/bwe/interceptor/...`
Should compile without errors
  </verify>
  <done>Abs-send-time parsing uses Pion's AbsSendTimeExtension.Unmarshal()</done>
</task>

<task type="auto">
  <name>Task 2: Replace ParseAbsCaptureTime with Pion Unmarshal</name>
  <files>pkg/bwe/interceptor/interceptor.go</files>
  <action>
In processRTP(), replace the abs-capture-time parsing section:

CURRENT CODE (lines ~187-201):
```go
if sendTime == 0 && captureID != 0 {
    if ext := header.GetExtension(captureID); len(ext) >= 8 {
        captureTime, err := bwe.ParseAbsCaptureTime(ext)
        if err == nil {
            // Convert 64-bit UQ32.32 to 24-bit 6.18 fixed point
            seconds := (captureTime >> 32) & 0x3F
            fraction := (captureTime >> 14) & 0x3FFFF
            sendTime = uint32((seconds << 18) | fraction)
        }
    }
}
```

REPLACE WITH (stack-allocated struct):
```go
if sendTime == 0 && captureID != 0 {
    if extData := header.GetExtension(captureID); len(extData) >= 8 {
        var ext rtp.AbsCaptureTimeExtension  // Stack allocated - CRITICAL for 0 allocs/op
        if err := ext.Unmarshal(extData); err == nil {
            // Convert 64-bit UQ32.32 to 24-bit 6.18 fixed point
            // AbsCaptureTime: upper 32 bits = seconds, lower 32 bits = fraction
            // We need seconds (6 bits) + fraction (18 bits) = 24 bits total
            seconds := (ext.Timestamp >> 32) & 0x3F    // 6 bits of seconds (mod 64)
            fraction := (ext.Timestamp >> 14) & 0x3FFFF // 18 bits of fraction
            sendTime = uint32((seconds << 18) | fraction)
        }
    }
}
```

NOTE: The conversion logic from UQ32.32 to 6.18 fixed point is UNCHANGED - this is KEEP-03 (custom inter-group delay calculation). Only the parsing method changes.
  </action>
  <verify>
Run: `go build ./pkg/bwe/interceptor/...`
Should compile without errors
  </verify>
  <done>Abs-capture-time parsing uses Pion's AbsCaptureTimeExtension.Unmarshal()</done>
</task>

<task type="auto">
  <name>Task 3: Remove bwe import if no longer needed and verify compilation</name>
  <files>pkg/bwe/interceptor/interceptor.go</files>
  <action>
After replacing both parse calls, check if the `bwe` package is still imported for other uses.

EXPECTED: The `bwe` package import is STILL NEEDED because processRTP uses:
- `bwe.BandwidthEstimator` (estimator field)
- `bwe.PacketInfo` (packet structure)
- `bwe.REMBScheduler` (REMB scheduling)

DO NOT remove the bwe import. Just verify compilation passes.

Run full test suite to ensure no behavioral regression:
```bash
go test ./pkg/bwe/interceptor/...
```

All existing tests must pass. The change should be transparent to callers.
  </action>
  <verify>
Run: `go test ./pkg/bwe/interceptor/... -v`
All tests should pass (especially any that exercise processRTP)
  </verify>
  <done>Interceptor compiles and all existing tests pass with Pion extension parsing</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `go build ./pkg/bwe/interceptor/...` - compiles without errors
2. `go test ./pkg/bwe/interceptor/...` - all tests pass
3. Code review: verify `var ext rtp.AbsSendTimeExtension` uses stack allocation (not `new()`)
4. Code review: verify `uint32(ext.Timestamp)` cast is used for abs-send-time
</verification>

<success_criteria>
- Pion extension types are used for parsing in processRTP
- All existing interceptor tests pass
- No new dependencies added (pion/rtp already in go.mod)
- Stack allocation pattern used for zero-allocation hot path
</success_criteria>

<output>
After completion, create `.planning/phases/05-pion-type-adoption/05-01-SUMMARY.md`
</output>
