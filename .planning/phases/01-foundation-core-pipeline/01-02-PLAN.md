---
phase: 01-foundation-core-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - pkg/bwe/interarrival.go
  - pkg/bwe/interarrival_test.go
autonomous: true

must_haves:
  truths:
    - "Packets arriving within 5ms (configurable) are grouped into a single burst"
    - "Inter-arrival delay variation is computed as (receive_delta - send_delta)"
    - "Groups use timestamps of last packet in group for inter-group calculations"
    - "32-bit RTP timestamp wraparound (6-13 hour) is handled correctly"
  artifacts:
    - path: "pkg/bwe/interarrival.go"
      provides: "Packet grouping and delay variation calculator"
      exports: ["InterArrivalCalculator", "PacketGroup", "NewInterArrivalCalculator"]
    - path: "pkg/bwe/interarrival_test.go"
      provides: "Unit tests for burst grouping and delay calculation"
      min_lines: 80
  key_links:
    - from: "pkg/bwe/interarrival.go"
      to: "pkg/bwe/timestamp.go"
      via: "uses UnwrapAbsSendTime for send delta"
      pattern: "UnwrapAbsSendTime"
    - from: "pkg/bwe/interarrival.go"
      to: "pkg/bwe/types.go"
      via: "uses PacketInfo struct"
      pattern: "PacketInfo"
---

<objective>
Implement inter-arrival time calculation with packet burst grouping.

Purpose: Video frames arrive as packet bursts. Computing delay per-packet produces noisy estimates. Grouping packets by 5ms threshold and computing inter-group delay variations gives meaningful congestion signals.

Output: InterArrivalCalculator that accumulates packets into groups and computes delay variation d(i) = t(i) - t(i-1) - (T(i) - T(i-1)) between consecutive groups.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-core-pipeline/01-RESEARCH.md
@pkg/bwe/types.go
@pkg/bwe/timestamp.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement PacketGroup and burst accumulation</name>
  <files>pkg/bwe/interarrival.go</files>
  <action>
Create `pkg/bwe/interarrival.go`:

1. Define `PacketGroup` struct:
```go
type PacketGroup struct {
    FirstSendTime   uint32    // First packet abs-send-time
    LastSendTime    uint32    // Last packet abs-send-time (used for inter-group delta)
    FirstArriveTime time.Time // First packet arrival (monotonic)
    LastArriveTime  time.Time // Last packet arrival (monotonic, used for inter-group delta)
    Size            int       // Total bytes in group
    NumPackets      int       // Packet count
}
```

2. Define `InterArrivalCalculator` struct:
```go
type InterArrivalCalculator struct {
    burstThreshold time.Duration // Default 5ms
    currentGroup   *PacketGroup  // Group being accumulated
    previousGroup  *PacketGroup  // Last completed group
}
```

3. Constructor `NewInterArrivalCalculator(burstThreshold time.Duration)`:
   - If burstThreshold <= 0, use default 5ms
   - Initialize currentGroup and previousGroup as nil

4. Method `(c *InterArrivalCalculator) BelongsToBurst(pkt PacketInfo) bool`:
   - If currentGroup is nil, return false (new group needed)
   - Compute arrival delta: `pkt.ArrivalTime.Sub(c.currentGroup.LastArriveTime)`
   - Return `arrivalDelta <= c.burstThreshold`

5. Method `(c *InterArrivalCalculator) AddPacket(pkt PacketInfo) (delayVariation time.Duration, hasResult bool)`:
   - If BelongsToBurst(pkt):
     - Update currentGroup: LastSendTime, LastArriveTime, Size += pkt.Size, NumPackets++
     - Return 0, false (no new measurement yet)
   - Else (new group):
     - If currentGroup != nil: move to previousGroup
     - Create new currentGroup from pkt
     - If previousGroup != nil: compute and return delay variation
     - Else: return 0, false

6. Method `(c *InterArrivalCalculator) computeDelayVariation() time.Duration`:
   - Receive delta: `c.currentGroup.LastArriveTime.Sub(c.previousGroup.LastArriveTime)`
   - Send delta: `UnwrapAbsSendTimeDuration(c.previousGroup.LastSendTime, c.currentGroup.LastSendTime)`
   - Return `receiveDelta - sendDelta`

7. Method `(c *InterArrivalCalculator) Reset()`:
   - Set currentGroup and previousGroup to nil
   - Called when stream resets or large gap detected

Note: The formula d(i) = t(i) - t(i-1) - (T(i) - T(i-1)) computes DELAY VARIATION, not absolute delay. Positive = increasing delay (queue building), negative = decreasing delay (queue draining).
  </action>
  <verify>
`go build ./pkg/bwe/...` succeeds
  </verify>
  <done>
InterArrivalCalculator accumulates packets into groups by burst threshold and computes delay variation when groups complete.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for burst grouping and delay variation</name>
  <files>pkg/bwe/interarrival_test.go</files>
  <action>
Create `pkg/bwe/interarrival_test.go` with comprehensive tests:

1. Test burst grouping (5ms threshold):
   - Send 3 packets with 2ms spacing -> all in same group
   - Send 4th packet with 10ms gap -> new group starts
   - Verify first group has NumPackets=3, second has NumPackets=1

2. Test delay variation calculation (stable network):
   - Group 1: arrive at t0, send_time=1000
   - Group 2: arrive at t0+100ms, send_time=1000+26214 (100ms in abs-send-time units)
   - Expected: delay variation ~0 (receive delta = send delta)

3. Test delay variation (increasing delay / queue building):
   - Group 1: arrive at t0, send_time=1000
   - Group 2: arrive at t0+120ms, send_time=1000+26214 (100ms sender side)
   - Expected: delay variation ~+20ms (receiver sees 120ms gap, sender sent 100ms gap)

4. Test delay variation (decreasing delay / queue draining):
   - Group 1: arrive at t0, send_time=1000
   - Group 2: arrive at t0+80ms, send_time=1000+26214 (100ms sender side)
   - Expected: delay variation ~-20ms (receiver sees 80ms gap, sender sent 100ms gap)

5. Test wraparound scenario:
   - Group 1: send_time near max (16777000)
   - Group 2: send_time wrapped around (500)
   - Verify delay variation is reasonable (not huge number)

6. Test configurable burst threshold:
   - Create calculator with 10ms threshold
   - Verify packets 8ms apart are grouped

7. Test Reset():
   - Add packets, call Reset(), verify no carryover state

Use MockClock for deterministic arrival times. Convert between ms and abs-send-time units: 1ms ~= 262.144 units (2^18 / 1000).
  </action>
  <verify>
`go test ./pkg/bwe/... -v -run InterArrival` passes all tests
  </verify>
  <done>
Tests verify burst grouping with 5ms threshold, delay variation formula correctness (positive for queue build, negative for drain), and wraparound handling.
  </done>
</task>

</tasks>

<verification>
1. `go test ./pkg/bwe/... -v` passes all interarrival tests
2. Burst grouping test: 3 packets within 5ms grouped, 4th after 10ms starts new group
3. Delay variation with +20ms queue build returns positive ~20ms
4. Delay variation with -20ms queue drain returns negative ~-20ms
5. Wraparound test produces reasonable delta, not huge number
</verification>

<success_criteria>
- DELAY-01: Inter-arrival time deltas computed correctly (receive - send delta)
- DELAY-02: Packet group aggregation with 5ms burst threshold working
- DELAY-03: 32-bit wraparound handled (inherited from timestamp.go)
- DELAY-04: Configurable burst threshold supported
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-core-pipeline/01-02-SUMMARY.md`
</output>
