---
phase: 01-foundation-core-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/bwe/types.go
  - pkg/bwe/timestamp.go
  - pkg/bwe/internal/clock.go
  - pkg/bwe/timestamp_test.go
autonomous: true

must_haves:
  truths:
    - "Abs-send-time 24-bit values are parsed correctly from 3-byte representations"
    - "Timestamps convert to time.Duration with 6.18 fixed-point precision"
    - "Wraparound at 64 seconds is handled correctly (forward and backward jumps)"
    - "Clock interface provides monotonic time for all delay calculations"
  artifacts:
    - path: "pkg/bwe/types.go"
      provides: "Core types, constants, BandwidthUsage enum"
      exports: ["BandwidthUsage", "BwNormal", "BwUnderusing", "BwOverusing", "PacketInfo"]
    - path: "pkg/bwe/timestamp.go"
      provides: "Timestamp parsing and wraparound handling"
      exports: ["ParseAbsSendTime", "UnwrapAbsSendTime", "AbsSendTimeToDuration"]
    - path: "pkg/bwe/internal/clock.go"
      provides: "Monotonic time abstraction"
      exports: ["Clock", "MonotonicClock", "MockClock"]
    - path: "pkg/bwe/timestamp_test.go"
      provides: "Unit tests for timestamp parsing and wraparound"
      min_lines: 50
  key_links:
    - from: "pkg/bwe/timestamp.go"
      to: "pkg/bwe/types.go"
      via: "import types for constants"
      pattern: "AbsSendTimeMax"
---

<objective>
Establish the type system, constants, and timestamp parsing for GCC receiver-side BWE.

Purpose: Create the foundational types that all other components depend on, plus correctly handle abs-send-time parsing with 64-second wraparound.

Output: Core types.go with BandwidthUsage enum and PacketInfo struct, timestamp.go with 24-bit 6.18 fixed-point parsing and wraparound handling, clock.go with monotonic time abstraction, and tests proving wraparound correctness.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-core-pipeline/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create core types and constants</name>
  <files>pkg/bwe/types.go, pkg/bwe/internal/clock.go</files>
  <action>
Create the directory structure and foundational files:

1. Create `pkg/bwe/types.go`:
   - Package `bwe`
   - `BandwidthUsage` type (int) with constants: `BwNormal`, `BwUnderusing`, `BwOverusing`
   - `PacketInfo` struct with fields:
     - `ArrivalTime time.Time` (monotonic)
     - `SendTime uint32` (24-bit abs-send-time value)
     - `Size int` (payload bytes)
     - `SSRC uint32`
   - Constants for abs-send-time:
     - `AbsSendTimeMax = 1 << 24` (16777216)
     - `AbsSendTimeResolution = 1.0 / (1 << 18)` seconds per unit (~3.8us)

2. Create `pkg/bwe/internal/clock.go`:
   - Package `internal`
   - `Clock` interface with `Now() time.Time`
   - `MonotonicClock` struct implementing Clock (returns time.Now())
   - `MockClock` struct for testing with:
     - `current time.Time` field
     - `Now()` returns current
     - `Advance(d time.Duration)` adds to current
     - `Set(t time.Time)` sets current directly

Ensure all time values use monotonic clock only (never time.Parse or time.Date).
  </action>
  <verify>
`go build ./pkg/bwe/...` succeeds with no errors
  </verify>
  <done>
types.go exports BandwidthUsage enum with 3 states, PacketInfo struct, and abs-send-time constants. clock.go provides Clock interface with MonotonicClock and MockClock implementations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement timestamp parsing with wraparound</name>
  <files>pkg/bwe/timestamp.go, pkg/bwe/timestamp_test.go</files>
  <action>
1. Create `pkg/bwe/timestamp.go`:
   - `ParseAbsSendTime(data []byte) (uint32, error)` - parse 3 bytes into 24-bit value
     - Return error if len(data) < 3
     - Big-endian: `(uint32(data[0])<<16) | (uint32(data[1])<<8) | uint32(data[2])`

   - `AbsSendTimeToDuration(value uint32) time.Duration` - convert to duration
     - Return `time.Duration(float64(value) * AbsSendTimeResolution * float64(time.Second))`
     - This gives microsecond precision from the 6.18 fixed-point format

   - `UnwrapAbsSendTime(prev, curr uint32) int64` - handle 64-second wraparound
     - Compute signed difference: `diff := int32(curr) - int32(prev)`
     - Apply half-range comparison for wraparound:
       - If `diff > AbsSendTimeMax/2`: `diff -= AbsSendTimeMax`
       - If `diff < -AbsSendTimeMax/2`: `diff += AbsSendTimeMax`
     - Return `int64(diff)` (signed delta in abs-send-time units)

   - `UnwrapAbsSendTimeDuration(prev, curr uint32) time.Duration` - delta as duration
     - Get unwrapped delta: `delta := UnwrapAbsSendTime(prev, curr)`
     - Convert to duration: `time.Duration(float64(delta) * AbsSendTimeResolution * float64(time.Second))`

2. Create `pkg/bwe/timestamp_test.go` with test cases:
   - Test basic parsing: `[]byte{0x00, 0x00, 0x01}` -> 1
   - Test max value: `[]byte{0xFF, 0xFF, 0xFF}` -> 16777215
   - Test wraparound forward: prev=16777000, curr=200 -> small positive delta (~216)
   - Test wraparound backward: prev=200, curr=16777000 -> small negative delta (~-216)
   - Test no wraparound: prev=1000, curr=2000 -> delta=1000
   - Test duration conversion: value=262144 (1<<18) -> exactly 1 second
   - Test error on short input

CRITICAL: The wraparound at 64s means packets that appear to have jumped by >32 seconds have actually wrapped. Use half-range comparison (>8388608 units).
  </action>
  <verify>
`go test ./pkg/bwe/... -v` passes all timestamp tests including wraparound edge cases
  </verify>
  <done>
Timestamp parsing handles 24-bit values, converts to duration with 6.18 fixed-point precision, and correctly unwraps 64-second wraparound in both directions. Tests prove wraparound edge cases work.
  </done>
</task>

</tasks>

<verification>
1. `go build ./pkg/bwe/...` compiles without errors
2. `go test ./pkg/bwe/... -v` passes all tests
3. Wraparound test with prev=16777000, curr=200 produces positive delta ~216
4. Wraparound test with prev=200, curr=16777000 produces negative delta ~-216
</verification>

<success_criteria>
- TIME-01: Abs-send-time 24-bit parsing implemented and tested
- TIME-02: 64-second wraparound handling correct for forward and backward cases
- PERF-03 (partial): Clock interface established with monotonic time only
- Foundation types available for all subsequent plans
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-core-pipeline/01-01-SUMMARY.md`
</output>
