---
phase: 07-network-simulation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/bwe/testutil/network.go
  - go.mod
  - go.sum
autonomous: true

must_haves:
  truths:
    - "User can create a VNetSimulator with NetworkCondition specifying latency, jitter, bandwidth, packet loss"
    - "VNetSimulator applies delay filter when Latency > 0"
    - "VNetSimulator applies bandwidth throttle when Bandwidth > 0"
    - "VNetSimulator applies packet loss when PacketLoss > 0"
    - "Jitter uses seeded rand/v2 for deterministic behavior"
  artifacts:
    - path: "pkg/bwe/testutil/network.go"
      provides: "VNetSimulator, NetworkCondition types"
      exports: ["VNetSimulator", "NetworkCondition", "NewVNetSimulator", "NetworkProfile*"]
    - path: "go.mod"
      provides: "pion/transport/v4 direct dependency"
      contains: "pion/transport/v4"
  key_links:
    - from: "pkg/bwe/testutil/network.go"
      to: "pion/transport/v4/vnet"
      via: "import and NewRouter/NewNet/DelayFilter/LossFilter/TokenBucketFilter usage"
      pattern: "vnet\\.New(Router|Net|DelayFilter|LossFilter|TokenBucketFilter)"
---

<objective>
Create network simulation helpers wrapping Pion vnet for controlled UDP/RTP network condition testing.

Purpose: Enable BWE E2E tests to inject latency, bandwidth limits, jitter, and packet loss into the media path. This is foundational for validating BWE behavior under realistic network conditions (NET-01 through NET-04).

Output: `pkg/bwe/testutil/network.go` with VNetSimulator and NetworkCondition types, plus predefined profiles for common test scenarios.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-network-simulation/07-RESEARCH.md

Relevant existing code:
@pkg/bwe/testutil/browser.go (pattern for testutil wrapper types)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NetworkCondition type and predefined profiles</name>
  <files>pkg/bwe/testutil/network.go</files>
  <action>
Create `pkg/bwe/testutil/network.go` with:

1. **NetworkCondition struct:**
```go
type NetworkCondition struct {
    Latency       time.Duration  // NET-01: Base delay for all packets
    Jitter        time.Duration  // NET-03: +/- random variation (requires Seed)
    Bandwidth     int64          // NET-02: Bytes per second (0 = unlimited)
    PacketLoss    float64        // NET-04: 0.0-1.0 loss probability
    BurstLossSize int            // NET-04: Consecutive packets to drop (0 = single)
    Seed          [2]uint64      // For deterministic jitter/loss
}
```

2. **Predefined profiles as package-level variables:**
```go
var (
    // NET-01: Constant 100ms latency
    ProfileConstantLatency100ms = NetworkCondition{
        Latency: 100 * time.Millisecond,
        Seed:    [2]uint64{1, 1},
    }

    // NET-02: 500 Kbps bandwidth cap (62500 bytes/sec)
    ProfileBandwidth500Kbps = NetworkCondition{
        Bandwidth: 62500, // 500 Kbps = 500*1000/8 bytes/sec
        Seed:      [2]uint64{2, 2},
    }

    // NET-03: 100ms base + 20ms jitter
    ProfileJitter20ms = NetworkCondition{
        Latency: 100 * time.Millisecond,
        Jitter:  20 * time.Millisecond,
        Seed:    [2]uint64{3, 3},
    }

    // NET-04: 5% random packet loss
    ProfileRandomLoss5Pct = NetworkCondition{
        PacketLoss: 0.05,
        Seed:       [2]uint64{4, 4},
    }

    // NET-04: Burst loss (3 consecutive packets, 2% trigger probability)
    ProfileBurstLoss3Pkt = NetworkCondition{
        PacketLoss:    0.02,
        BurstLossSize: 3,
        Seed:          [2]uint64{5, 5},
    }
)
```

Do NOT implement VNetSimulator yet (Task 2).

Import only `time` for now - vnet imports come in Task 2.
  </action>
  <verify>
```bash
go build ./pkg/bwe/testutil/
```
Package compiles with NetworkCondition type and profile variables.
  </verify>
  <done>NetworkCondition struct exported with 5 predefined profiles matching NET-01 through NET-04 requirements.</done>
</task>

<task type="auto">
  <name>Task 2: Create VNetSimulator wrapper with vnet integration</name>
  <files>pkg/bwe/testutil/network.go, go.mod, go.sum</files>
  <action>
Add VNetSimulator to `pkg/bwe/testutil/network.go`:

1. **Promote pion/transport/v4 to direct dependency:**
```bash
go get github.com/pion/transport/v4@v4.0.1
```
(Already indirect, making it direct for vnet usage)

2. **Add imports:**
```go
import (
    "context"
    "math/rand/v2"
    "time"

    "github.com/pion/logging"
    "github.com/pion/transport/v4/vnet"
)
```

3. **VNetSimulator struct:**
```go
// VNetSimulator wraps vnet with network condition configuration.
type VNetSimulator struct {
    router *vnet.Router
    nets   []*vnet.Net
    cond   NetworkCondition
    rng    *rand.Rand
    cancel context.CancelFunc
}
```

4. **NewVNetSimulator constructor:**
```go
// NewVNetSimulator creates a virtual network simulator.
// Call Start() to begin routing, Stop() to shut down.
func NewVNetSimulator(cond NetworkCondition) (*VNetSimulator, error) {
    ctx, cancel := context.WithCancel(context.Background())
    _ = ctx // Used by filters when started

    router, err := vnet.NewRouter(&vnet.RouterConfig{
        CIDR:          "192.168.0.0/24",
        LoggerFactory: logging.NewDefaultLoggerFactory(),
    })
    if err != nil {
        cancel()
        return nil, fmt.Errorf("failed to create router: %w", err)
    }

    sim := &VNetSimulator{
        router: router,
        cond:   cond,
        cancel: cancel,
    }

    // Create seeded RNG if jitter or loss configured
    if cond.Jitter > 0 || cond.PacketLoss > 0 {
        sim.rng = rand.New(rand.NewPCG(cond.Seed[0], cond.Seed[1]))
    }

    return sim, nil
}
```

5. **AddNet method** (applies filters based on condition):
```go
// AddNet creates a virtual network endpoint with the configured conditions.
func (s *VNetSimulator) AddNet(ip string) (*vnet.Net, error) {
    net := vnet.NewNet(&vnet.NetConfig{
        StaticIPs: []string{ip},
    })

    if err := s.router.AddNet(net); err != nil {
        return nil, fmt.Errorf("failed to add net: %w", err)
    }

    // Apply delay filter if latency configured
    if s.cond.Latency > 0 {
        // Note: vnet DelayFilter applies constant delay
        // Jitter would need custom implementation (deferred to advanced scenarios)
        _, err := vnet.NewDelayFilter(net.NIC(), s.cond.Latency)
        if err != nil {
            return nil, fmt.Errorf("failed to create delay filter: %w", err)
        }
    }

    // Apply loss filter if packet loss configured
    if s.cond.PacketLoss > 0 {
        lossPercent := int(s.cond.PacketLoss * 100)
        if lossPercent < 1 {
            lossPercent = 1 // Minimum 1% for LossFilter
        }
        _, err := vnet.NewLossFilter(net.NIC(), lossPercent)
        if err != nil {
            return nil, fmt.Errorf("failed to create loss filter: %w", err)
        }
    }

    // Apply bandwidth filter if configured
    if s.cond.Bandwidth > 0 {
        _, err := vnet.NewTokenBucketFilter(net.NIC(),
            vnet.TBFRate(int(s.cond.Bandwidth)),
            vnet.TBFMaxBurst(1500), // MTU-sized burst
        )
        if err != nil {
            return nil, fmt.Errorf("failed to create bandwidth filter: %w", err)
        }
    }

    s.nets = append(s.nets, net)
    return net, nil
}
```

6. **Lifecycle methods:**
```go
// Router returns the underlying vnet.Router.
func (s *VNetSimulator) Router() *vnet.Router {
    return s.router
}

// Start begins routing packets between virtual networks.
func (s *VNetSimulator) Start() error {
    return s.router.Start()
}

// Stop shuts down the simulator and all virtual networks.
func (s *VNetSimulator) Stop() error {
    s.cancel()
    return s.router.Stop()
}
```

Add `"fmt"` to imports for error wrapping.
  </action>
  <verify>
```bash
go build ./pkg/bwe/testutil/
grep "pion/transport/v4" go.mod | head -1
```
Package compiles. pion/transport/v4 appears as direct dependency in go.mod.
  </verify>
  <done>VNetSimulator wraps vnet.Router with NetworkCondition-driven filter configuration. AddNet applies delay/loss/bandwidth filters.</done>
</task>

<task type="auto">
  <name>Task 3: Add unit test for VNetSimulator</name>
  <files>pkg/bwe/testutil/network_test.go</files>
  <action>
Create `pkg/bwe/testutil/network_test.go` to verify VNetSimulator API:

```go
package testutil

import (
    "testing"
)

func TestVNetSimulator_Creation(t *testing.T) {
    // Test basic creation with no conditions
    sim, err := NewVNetSimulator(NetworkCondition{})
    if err != nil {
        t.Fatalf("NewVNetSimulator failed: %v", err)
    }
    defer sim.Stop()

    // Add two networks
    net1, err := sim.AddNet("192.168.0.1")
    if err != nil {
        t.Fatalf("AddNet failed: %v", err)
    }
    if net1 == nil {
        t.Fatal("AddNet returned nil net")
    }

    net2, err := sim.AddNet("192.168.0.2")
    if err != nil {
        t.Fatalf("AddNet failed: %v", err)
    }
    if net2 == nil {
        t.Fatal("AddNet returned nil net")
    }

    // Start router
    if err := sim.Start(); err != nil {
        t.Fatalf("Start failed: %v", err)
    }

    // Router should be accessible
    if sim.Router() == nil {
        t.Fatal("Router() returned nil")
    }
}

func TestVNetSimulator_WithLatency(t *testing.T) {
    sim, err := NewVNetSimulator(ProfileConstantLatency100ms)
    if err != nil {
        t.Fatalf("NewVNetSimulator failed: %v", err)
    }
    defer sim.Stop()

    // Adding net should succeed with delay filter
    net, err := sim.AddNet("192.168.0.1")
    if err != nil {
        t.Fatalf("AddNet with latency failed: %v", err)
    }
    if net == nil {
        t.Fatal("AddNet returned nil")
    }
}

func TestVNetSimulator_WithBandwidth(t *testing.T) {
    sim, err := NewVNetSimulator(ProfileBandwidth500Kbps)
    if err != nil {
        t.Fatalf("NewVNetSimulator failed: %v", err)
    }
    defer sim.Stop()

    // Adding net should succeed with bandwidth filter
    net, err := sim.AddNet("192.168.0.1")
    if err != nil {
        t.Fatalf("AddNet with bandwidth failed: %v", err)
    }
    if net == nil {
        t.Fatal("AddNet returned nil")
    }
}

func TestVNetSimulator_WithPacketLoss(t *testing.T) {
    sim, err := NewVNetSimulator(ProfileRandomLoss5Pct)
    if err != nil {
        t.Fatalf("NewVNetSimulator failed: %v", err)
    }
    defer sim.Stop()

    // Adding net should succeed with loss filter
    net, err := sim.AddNet("192.168.0.1")
    if err != nil {
        t.Fatalf("AddNet with loss failed: %v", err)
    }
    if net == nil {
        t.Fatal("AddNet returned nil")
    }
}

func TestNetworkProfiles_Defined(t *testing.T) {
    // Verify all profiles are defined and have expected values
    profiles := []struct {
        name    string
        cond    NetworkCondition
        latency bool
        bw      bool
        loss    bool
    }{
        {"ConstantLatency100ms", ProfileConstantLatency100ms, true, false, false},
        {"Bandwidth500Kbps", ProfileBandwidth500Kbps, false, true, false},
        {"Jitter20ms", ProfileJitter20ms, true, false, false},
        {"RandomLoss5Pct", ProfileRandomLoss5Pct, false, false, true},
        {"BurstLoss3Pkt", ProfileBurstLoss3Pkt, false, false, true},
    }

    for _, p := range profiles {
        t.Run(p.name, func(t *testing.T) {
            if p.latency && p.cond.Latency == 0 {
                t.Errorf("%s: expected latency > 0", p.name)
            }
            if p.bw && p.cond.Bandwidth == 0 {
                t.Errorf("%s: expected bandwidth > 0", p.name)
            }
            if p.loss && p.cond.PacketLoss == 0 {
                t.Errorf("%s: expected packet loss > 0", p.name)
            }
        })
    }
}
```
  </action>
  <verify>
```bash
go test -v ./pkg/bwe/testutil/ -run "VNetSimulator|NetworkProfiles"
```
All tests pass, verifying VNetSimulator creation with various network conditions.
  </verify>
  <done>Unit tests verify VNetSimulator API: creation, AddNet with filters, lifecycle methods, and predefined profiles.</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Type exports:**
```bash
go doc ./pkg/bwe/testutil/ | grep -E "(NetworkCondition|VNetSimulator|Profile)"
```
Should show exported types and profile variables.

2. **Package builds:**
```bash
go build ./pkg/bwe/testutil/
```
No errors.

3. **Tests pass:**
```bash
go test ./pkg/bwe/testutil/ -run "VNet"
```
All VNetSimulator tests pass.

4. **vnet dependency:**
```bash
grep -E "pion/transport/v4" go.mod
```
Shows as direct dependency.
</verification>

<success_criteria>
- NetworkCondition struct exported with Latency, Jitter, Bandwidth, PacketLoss, BurstLossSize, Seed fields
- 5 predefined profiles exported: ProfileConstantLatency100ms, ProfileBandwidth500Kbps, ProfileJitter20ms, ProfileRandomLoss5Pct, ProfileBurstLoss3Pkt
- VNetSimulator wraps vnet.Router with NewVNetSimulator, AddNet, Start, Stop, Router methods
- AddNet applies delay/loss/bandwidth filters based on NetworkCondition
- Unit tests verify API works with each filter type
- pion/transport/v4 is direct dependency in go.mod
</success_criteria>

<output>
After completion, create `.planning/phases/07-network-simulation/07-01-SUMMARY.md`
</output>
