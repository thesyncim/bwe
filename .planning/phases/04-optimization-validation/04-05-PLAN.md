---
phase: 04-optimization-validation
plan: 05
type: execute
wave: 3
depends_on: ["04-01"]
files_modified:
  - pkg/bwe/soak_test.go
  - cmd/soak/main.go
autonomous: true

must_haves:
  truths:
    - "Soak test runs for simulated 24 hours without crashing"
    - "Memory usage stays bounded (no leaks)"
    - "No timestamp-related failures at wraparound points"
    - "Estimates remain reasonable throughout"
  artifacts:
    - path: "pkg/bwe/soak_test.go"
      provides: "VALID-04 accelerated soak test"
      exports: ["TestSoak24Hour_Accelerated", "TestTimestampWraparound"]
    - path: "cmd/soak/main.go"
      provides: "Real-time soak test runner with pprof"
      exports: ["main"]
  key_links:
    - from: "soak_test.go"
      to: "BandwidthEstimator"
      via: "24-hour simulated packet processing"
      pattern: "clock.Advance"
---

<objective>
Create 24-hour soak test for VALID-04 requirement.

Purpose: Verify the estimator runs for 24 hours without timestamp-related failures or memory leaks. Uses accelerated mock clock for CI (minutes) and provides real-time runner for overnight testing.

Output: Accelerated soak test for CI and real-time soak runner with pprof monitoring.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-optimization-validation/04-RESEARCH.md

@pkg/bwe/bandwidth_estimator.go
@pkg/bwe/timestamp.go
@pkg/bwe/internal/clock.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create accelerated soak test for CI</name>
  <files>pkg/bwe/soak_test.go</files>
  <action>
Create accelerated 24-hour soak test using mock clock:

1. Create `TestSoak24Hour_Accelerated`:
   ```go
   // TestSoak24Hour_Accelerated simulates 24 hours of traffic in accelerated time.
   // Uses MockClock to simulate time progression without waiting.
   //
   // This test verifies VALID-04:
   // - No timestamp-related failures
   // - No memory leaks (bounded memory growth)
   // - Estimates remain reasonable throughout
   func TestSoak24Hour_Accelerated(t *testing.T)
   ```

2. Implementation:
   - Simulate 24 hours with 20ms packet intervals (50 pps)
   - Total packets: 24 * 60 * 60 * 50 = 4,320,000 packets
   - Use batched processing: process 1 hour at a time, then check health
   - Track memory stats with runtime.ReadMemStats every simulated hour

3. Health checks every simulated hour:
   - Memory growth check: HeapAlloc < 100MB (no unbounded growth)
   - Estimate sanity: estimate > 0 and estimate < 1 Gbps
   - Log: hour number, HeapAlloc, NumGC, current estimate

4. Timestamp wraparound verification:
   - abs-send-time wraps every 64 seconds
   - After 24 hours: 24*60*60/64 = 1350 wraparounds
   - Test should not panic or produce NaN/Inf estimates at wraparound

5. Make test not too slow for CI:
   - Target: complete in < 2 minutes wall-clock time
   - May need to reduce packet count or check frequency
   - Use `testing.Short()` to skip in short mode with reduced duration

6. Final assertions:
   - No panics occurred
   - Final estimate is reasonable (not 0, not NaN)
   - Memory at end vs start: < 50% growth (accounting for GC)
  </action>
  <verify>
Run: `go test -v -run TestSoak24Hour_Accelerated ./pkg/bwe/... -timeout 5m`
Expected: Test passes, logs hourly stats
  </verify>
  <done>Accelerated 24-hour soak test implemented</done>
</task>

<task type="auto">
  <name>Task 2: Create timestamp wraparound stress test</name>
  <files>pkg/bwe/soak_test.go</files>
  <action>
Create focused timestamp wraparound tests:

1. Create `TestTimestampWraparound_64Seconds`:
   - Generate packets across the 64-second abs-send-time boundary
   - Verify no errors or panics at wraparound
   - Verify delay calculation is correct across wrap

2. Create `TestTimestampWraparound_MultipleWraps`:
   - Simulate 10 wraparound cycles (640 seconds = ~10 minutes)
   - Process packets continuously
   - Verify estimates remain stable (no sudden jumps at wrap)

3. Create `TestTimestampWraparound_RTPTimestamp`:
   - RTP timestamp wraps at 2^32 (~13 hours at 90kHz video, ~6 hours at 48kHz audio)
   - While our implementation uses abs-send-time (not RTP timestamp), document this
   - Add comment about future TWCC implementation considerations

4. Add edge case tests:
   - Packet arriving exactly at max timestamp value
   - Packet with timestamp 0 after max
   - Large gap (simulating packet loss) across wraparound

5. Log any suspicious behavior:
   - Estimate jumps > 50% at wraparound
   - Negative estimates
   - NaN or Inf values
  </action>
  <verify>
Run: `go test -v -run TestTimestampWraparound ./pkg/bwe/...`
Expected: All wraparound tests pass
  </verify>
  <done>Timestamp wraparound stress tests implemented</done>
</task>

<task type="auto">
  <name>Task 3: Create real-time soak runner with pprof</name>
  <files>cmd/soak/main.go</files>
  <action>
Create command-line soak test runner for real 24-hour testing:

1. Create `cmd/soak/` directory

2. Implement main.go:
   ```go
   // Soak test runner for VALID-04 long-duration testing.
   //
   // Usage:
   //   go run ./cmd/soak -duration 24h
   //   go run ./cmd/soak -duration 1h  # shorter test
   //
   // Exposes pprof endpoint at :6060 for live profiling:
   //   curl http://localhost:6060/debug/pprof/heap > heap.pprof
   //   go tool pprof heap.pprof
   ```

3. Features:
   - Flag: `-duration` (default 24h)
   - Flag: `-pprof-port` (default 6060)
   - HTTP pprof endpoint for live profiling
   - Periodic status output (every 5 minutes)
   - Graceful shutdown on SIGINT/SIGTERM

4. Status output format:
   ```
   [00:05:00] Packets: 15000, Estimate: 1.5 Mbps, HeapAlloc: 2.1 MB, NumGC: 12
   [00:10:00] Packets: 30000, Estimate: 1.6 Mbps, HeapAlloc: 2.3 MB, NumGC: 24
   ```

5. Final summary:
   ```
   Soak Test Complete
   ==================
   Duration: 24h0m0s
   Total packets: 4,320,000
   Final estimate: 1.58 Mbps
   Peak HeapAlloc: 3.2 MB
   Total GC cycles: 576
   Status: PASS
   ```

6. Pass criteria (logged):
   - No panics
   - Final estimate > 0
   - Peak memory < 100 MB
   - No timestamp errors logged

This allows nightly CI or manual 24-hour validation.
  </action>
  <verify>
Build: `go build ./cmd/soak/...`
Run briefly: `timeout 10 go run ./cmd/soak -duration 1m || true`
Expected: Shows status output, builds successfully
  </verify>
  <done>Real-time soak runner with pprof implemented</done>
</task>

</tasks>

<verification>
VALID-04 Requirement Check:
1. Accelerated test passes: `go test -v -run TestSoak24Hour ./pkg/bwe/... -timeout 5m`
2. Wraparound tests pass: `go test -v -run TestTimestampWraparound ./pkg/bwe/...`
3. Soak runner builds: `go build ./cmd/soak/...`
4. No memory leaks (HeapAlloc bounded)
5. No timestamp failures at wraparound points

All tests pass: `go test ./pkg/bwe/...`
</verification>

<success_criteria>
- [ ] soak_test.go exists with TestSoak24Hour_Accelerated
- [ ] Timestamp wraparound tests exist and pass
- [ ] cmd/soak/main.go builds and runs
- [ ] Accelerated test completes in < 2 minutes
- [ ] No memory leaks detected (bounded HeapAlloc)
- [ ] No timestamp-related failures at wraparound points
- [ ] All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-optimization-validation/04-05-SUMMARY.md`
</output>
