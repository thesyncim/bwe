---
phase: 04-optimization-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/bwe/benchmark_test.go
  - pkg/bwe/interceptor/benchmark_test.go
autonomous: true

must_haves:
  truths:
    - "Benchmark reports allocations per operation"
    - "Steady-state packet processing shows <1 alloc/op"
    - "Escape analysis identifies any remaining heap allocations"
  artifacts:
    - path: "pkg/bwe/benchmark_test.go"
      provides: "Allocation-focused benchmarks for core estimator"
      exports: ["BenchmarkBandwidthEstimator_OnPacket_ZeroAlloc"]
    - path: "pkg/bwe/interceptor/benchmark_test.go"
      provides: "Allocation-focused benchmarks for interceptor hot path"
      exports: ["BenchmarkProcessRTP_Allocations", "BenchmarkInterceptor_FullPath"]
  key_links:
    - from: "benchmark_test.go"
      to: "BandwidthEstimator.OnPacket"
      via: "b.ReportAllocs() + b.N iterations"
      pattern: "ReportAllocs"
---

<objective>
Profile and verify allocation counts for PERF-01 requirement.

Purpose: Verify that steady-state packet processing allocates less than 1 object per packet, using Go's benchmark infrastructure with `-benchmem` and escape analysis.

Output: Benchmark tests that verify <1 alloc/op, documented allocation sources if any remain.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-optimization-validation/04-RESEARCH.md

@pkg/bwe/bandwidth_estimator.go
@pkg/bwe/bandwidth_estimator_test.go
@pkg/bwe/interceptor/interceptor.go
@pkg/bwe/interceptor/pool.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create allocation-focused benchmarks for core estimator</name>
  <files>pkg/bwe/benchmark_test.go</files>
  <action>
Create a new benchmark file focused on allocation verification:

1. Create `BenchmarkBandwidthEstimator_OnPacket_ZeroAlloc`:
   - Call `b.ReportAllocs()` at start
   - Pre-allocate all test data outside the benchmark loop
   - Use `b.ResetTimer()` before measurement
   - Assign result to package-level var to prevent optimization
   - Target: 0 allocs/op in steady state

2. Create `BenchmarkDelayEstimator_OnPacket_ZeroAlloc`:
   - Same pattern for the delay estimator component
   - Verifies no allocations in the filter/detector chain

3. Add helper comments documenting:
   - How to run: `go test -bench=ZeroAlloc -benchmem ./pkg/bwe/...`
   - Expected output: `0 allocs/op`
   - How to debug if failing: escape analysis command

Use patterns from 04-RESEARCH.md Pattern 1 (Allocation-Focused Benchmarks).
  </action>
  <verify>
Run: `go test -bench=ZeroAlloc -benchmem ./pkg/bwe/... 2>&1 | grep -E "(allocs/op|PASS|FAIL)"`
Expected: Shows allocs/op metrics and PASS
  </verify>
  <done>Core estimator benchmarks exist and report allocation counts</done>
</task>

<task type="auto">
  <name>Task 2: Create allocation benchmarks for interceptor hot path</name>
  <files>pkg/bwe/interceptor/benchmark_test.go</files>
  <action>
Create interceptor-specific allocation benchmarks:

1. Create `BenchmarkProcessRTP_Allocations`:
   - Benchmark the processRTP method directly
   - Use sync.Pool-enabled code path (already implemented in pool.go)
   - Verify pool usage is working correctly
   - Target: 0 allocs/op (pool reuses PacketInfo)

2. Create `BenchmarkInterceptor_FullPath`:
   - Benchmark from RTP bytes to estimator.OnPacket
   - Includes header parsing (rtp.Header.Unmarshal)
   - Includes extension extraction
   - Documents any unavoidable allocations (e.g., rtp.Header internals)

3. Add escape analysis verification helper:
   - Comment showing: `go build -gcflags="-m" ./pkg/bwe/interceptor 2>&1 | grep "escapes to heap"`
   - Document expected escapes (if any) vs unexpected escapes

Note: rtp.Header.Unmarshal may allocate internally - document this as known/acceptable if it occurs.
  </action>
  <verify>
Run: `go test -bench=. -benchmem ./pkg/bwe/interceptor/... 2>&1 | grep -E "(allocs/op|PASS|FAIL)"`
Expected: Shows allocation counts, PASS
  </verify>
  <done>Interceptor benchmarks exist with allocation reporting</done>
</task>

<task type="auto">
  <name>Task 3: Run escape analysis and document findings</name>
  <files>pkg/bwe/benchmark_test.go</files>
  <action>
Run escape analysis and document results:

1. Run escape analysis on both packages:
   ```bash
   go build -gcflags="-m" ./pkg/bwe 2>&1 | grep -E "(escapes|moved to heap)"
   go build -gcflags="-m" ./pkg/bwe/interceptor 2>&1 | grep -E "(escapes|moved to heap)"
   ```

2. Document findings in benchmark_test.go comments:
   - List any heap escapes in the hot path
   - For each escape, note if it's:
     - Acceptable (e.g., sync.Pool.Get returns interface{})
     - Needs optimization (e.g., fmt.Printf in hot path)
     - External library (e.g., pion/rtp internals)

3. If any optimizable escapes found, add TODO comments with specific fix suggestions.

4. Run full benchmark suite and record baseline:
   ```bash
   go test -bench=. -benchmem ./pkg/bwe/... | tee benchmark_baseline.txt
   ```

PERF-01 verification: If benchmarks show 0-1 allocs/op in steady state (after warmup), requirement is MET.
  </action>
  <verify>
Run escape analysis: `go build -gcflags="-m" ./pkg/bwe/interceptor 2>&1 | head -20`
Run benchmarks: `go test -bench=ZeroAlloc -benchmem ./pkg/bwe/...`
Expected: Escape analysis runs, benchmarks show allocation counts
  </verify>
  <done>Escape analysis documented, PERF-01 verification complete with benchmark evidence</done>
</task>

</tasks>

<verification>
PERF-01 Requirement Check:
1. Run allocation benchmarks: `go test -bench=ZeroAlloc -benchmem ./pkg/bwe/...`
2. Verify output shows `0 allocs/op` or `<1 allocs/op` average
3. Run interceptor benchmarks: `go test -bench=. -benchmem ./pkg/bwe/interceptor/...`
4. Document any unavoidable allocations (external libraries)

All tests must pass: `go test ./pkg/bwe/...`
</verification>

<success_criteria>
- [ ] benchmark_test.go exists in pkg/bwe with ZeroAlloc benchmarks
- [ ] benchmark_test.go exists in pkg/bwe/interceptor with allocation benchmarks
- [ ] Running benchmarks with -benchmem shows allocation counts
- [ ] Steady-state packet processing shows 0-1 allocs/op
- [ ] Escape analysis findings documented in comments
- [ ] All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-optimization-validation/04-01-SUMMARY.md`
</output>
