---
phase: 04-optimization-validation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/bwe/testutil/reference_trace.go
  - pkg/bwe/validation_test.go
  - testdata/reference_congestion.json
autonomous: true

must_haves:
  truths:
    - "Reference trace with expected estimates can be loaded"
    - "Our estimates can be compared against reference values"
    - "Divergence percentage is calculated and reported"
  artifacts:
    - path: "pkg/bwe/testutil/reference_trace.go"
      provides: "Trace replay infrastructure with reference comparison"
      exports: ["ReferenceTrace", "TracedPacket", "LoadTrace", "Replay"]
    - path: "pkg/bwe/validation_test.go"
      provides: "VALID-01 divergence test"
      exports: ["TestEstimateDivergence_ReferenceComparison"]
    - path: "testdata/reference_congestion.json"
      provides: "Sample trace for validation"
      contains: "ReferenceEstimate"
  key_links:
    - from: "validation_test.go"
      to: "testutil/reference_trace.go"
      via: "LoadTrace + Replay"
      pattern: "LoadTrace.*Replay"
---

<objective>
Create test harness for comparing bandwidth estimates against reference values for VALID-01.

Purpose: Enable comparison of our bandwidth estimates against libwebrtc reference values using packet trace replay. The <10% divergence requirement ensures our GCC implementation behaves like Chrome's.

Output: Trace replay infrastructure and divergence test that can validate VALID-01.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-optimization-validation/04-RESEARCH.md

@pkg/bwe/testutil/traces.go
@pkg/bwe/bandwidth_estimator.go
@pkg/bwe/internal/clock.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reference trace infrastructure</name>
  <files>pkg/bwe/testutil/reference_trace.go</files>
  <action>
Create reference trace replay infrastructure:

1. Define `TracedPacket` struct:
   ```go
   type TracedPacket struct {
       ArrivalTimeUs     int64  `json:"arrival_time_us"`     // Microseconds since trace start
       SendTime          uint32 `json:"send_time"`           // abs-send-time 24-bit
       Size              int    `json:"size"`
       SSRC              uint32 `json:"ssrc"`
       ReferenceEstimate int64  `json:"reference_estimate"`  // Expected estimate from libwebrtc (0 if unknown)
   }
   ```

2. Define `ReferenceTrace` struct:
   ```go
   type ReferenceTrace struct {
       Name        string         `json:"name"`
       Description string         `json:"description"`
       Packets     []TracedPacket `json:"packets"`
   }
   ```

3. Implement `LoadTrace(path string) (*ReferenceTrace, error)`:
   - Read JSON file from path
   - Unmarshal into ReferenceTrace
   - Return error if file not found or invalid

4. Implement `Replay` method on ReferenceTrace:
   ```go
   func (t *ReferenceTrace) Replay(estimator *bwe.BandwidthEstimator, clock *internal.MockClock) []int64
   ```
   - Iterate through packets in order
   - Advance clock to match ArrivalTimeUs
   - Call estimator.OnPacket with converted PacketInfo
   - Return slice of our estimates for comparison

5. Add `CalculateDivergence(ourEstimates []int64, trace *ReferenceTrace, warmupPackets int) (maxDivergence, avgDivergence float64)`:
   - Skip first N packets (warmup period)
   - Only compare where ReferenceEstimate > 0
   - Return max and average divergence as percentages
  </action>
  <verify>
Build: `go build ./pkg/bwe/testutil/...`
Expected: No errors
  </verify>
  <done>Reference trace types and replay infrastructure implemented</done>
</task>

<task type="auto">
  <name>Task 2: Create sample reference trace for testing</name>
  <files>testdata/reference_congestion.json</files>
  <action>
Create a sample reference trace file for validation testing:

1. Create testdata directory if needed: `mkdir -p testdata`

2. Create `reference_congestion.json` with a synthetic congestion scenario:
   - 500 packets over ~10 seconds
   - Phase 1 (packets 0-200): Stable network, estimates should increase toward available bandwidth
   - Phase 2 (packets 200-350): Congestion starts, delay increases, estimates should decrease
   - Phase 3 (packets 350-500): Congestion clears, estimates should recover

3. Generate packet data programmatically (can be done in test setup):
   - 20ms packet intervals (50 pps)
   - 1200 byte packets
   - Single SSRC
   - Phase 2: Add 0.5ms delay increase per packet (simulates queue building)
   - Phase 3: Subtract 0.3ms delay per packet (simulates queue draining)

4. For ReferenceEstimate values:
   - Set to 0 for initial warmup (first 100 packets)
   - For validation, use reasonable expected values:
     - Phase 1 end: ~2 Mbps (stable at incoming rate)
     - Phase 2 end: ~1.2 Mbps (after 85% decrease)
     - Phase 3 end: ~1.8 Mbps (recovery)

NOTE: Without actual libwebrtc comparison data, use placeholder estimates. The infrastructure is the deliverable; real reference data can be added later from Chrome RTC event logs.
  </action>
  <verify>
Validate JSON: `cat testdata/reference_congestion.json | python3 -m json.tool > /dev/null && echo "Valid JSON"`
Expected: "Valid JSON"
  </verify>
  <done>Sample reference trace exists with synthetic congestion scenario</done>
</task>

<task type="auto">
  <name>Task 3: Create divergence validation test</name>
  <files>pkg/bwe/validation_test.go</files>
  <action>
Create VALID-01 divergence test:

1. Create `TestEstimateDivergence_ReferenceComparison`:
   - Load reference trace from testdata
   - Create BandwidthEstimator with default config
   - Use MockClock for deterministic replay
   - Replay trace through estimator
   - Calculate divergence against reference estimates

2. Test assertions:
   - Log max divergence and avg divergence
   - Assert max divergence < 10% (VALID-01 requirement)
   - Assert avg divergence < 5% (stricter for confidence)

3. Add `TestEstimateDivergence_GeneratedTrace`:
   - For cases where reference data unavailable
   - Generate trace programmatically
   - Compare against expected behavior patterns:
     - Stable: estimate within 20% of incoming rate
     - Congestion: estimate decreases
     - Recovery: estimate increases
   - This provides basic sanity checking even without libwebrtc data

4. Add skip condition for missing reference data:
   ```go
   if _, err := os.Stat("testdata/reference_congestion.json"); os.IsNotExist(err) {
       t.Skip("Reference trace not available")
   }
   ```

5. Add test documentation:
   - How to obtain real reference traces from Chrome RTC event logs
   - Link to rtc_event_log_visualizer documentation
  </action>
  <verify>
Run: `go test -v -run TestEstimateDivergence ./pkg/bwe/...`
Expected: Tests pass (or skip if reference data missing)
  </verify>
  <done>VALID-01 divergence test implemented with reference comparison infrastructure</done>
</task>

</tasks>

<verification>
VALID-01 Requirement Check:
1. Reference trace infrastructure exists: `ls pkg/bwe/testutil/reference_trace.go`
2. Sample trace exists: `ls testdata/reference_congestion.json`
3. Divergence test runs: `go test -v -run TestEstimateDivergence ./pkg/bwe/...`
4. If reference data available, max divergence < 10%

All tests pass: `go test ./pkg/bwe/...`
</verification>

<success_criteria>
- [ ] reference_trace.go exists with LoadTrace, Replay, CalculateDivergence
- [ ] Sample reference trace JSON exists in testdata/
- [ ] validation_test.go exists with divergence tests
- [ ] Tests pass (or skip gracefully if reference data missing)
- [ ] Infrastructure ready for real libwebrtc comparison when data available
- [ ] All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-optimization-validation/04-02-SUMMARY.md`
</output>
