---
phase: 02-rate-control-remb
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/bwe/rate_stats.go
  - pkg/bwe/rate_stats_test.go
autonomous: true

must_haves:
  truths:
    - "RateStats accurately measures incoming bitrate over a configurable time window"
    - "Expired samples are automatically removed when window slides"
    - "Rate calculation returns false when insufficient data exists"
    - "Rate measurement handles packet gaps correctly"
  artifacts:
    - path: "pkg/bwe/rate_stats.go"
      provides: "Sliding window bitrate measurement"
      exports: ["RateStats", "NewRateStats", "Update", "Rate", "Reset"]
    - path: "pkg/bwe/rate_stats_test.go"
      provides: "Unit tests for rate measurement"
      min_lines: 100
  key_links:
    - from: "pkg/bwe/rate_stats.go"
      to: "time.Duration window"
      via: "configurable window size"
      pattern: "windowSize.*time\\.Duration"
---

<objective>
Implement sliding window incoming bitrate measurement for the AIMD rate controller.

Purpose: The rate controller needs accurate measurement of actual incoming bitrate to apply multiplicative decrease correctly. Per GCC spec, decrease is 0.85 * measured_incoming_rate (NOT current estimate).

Output: RateStats type that tracks bytes over a configurable time window and computes bits-per-second rate.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-rate-control-remb/02-RESEARCH.md

# Phase 1 established patterns
@pkg/bwe/types.go
@pkg/bwe/estimator.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RateStats sliding window implementation</name>
  <files>pkg/bwe/rate_stats.go</files>
  <action>
Create `pkg/bwe/rate_stats.go` implementing sliding window bitrate measurement.

Structure (from research Pattern 4):
```go
// RateStatsConfig configures the sliding window rate measurement.
type RateStatsConfig struct {
    WindowSize time.Duration // Default: 1 second
}

// DefaultRateStatsConfig returns default configuration.
func DefaultRateStatsConfig() RateStatsConfig

// RateStats tracks incoming bitrate over a sliding time window.
type RateStats struct {
    windowSize time.Duration
    samples    []sample  // Each sample: {timestamp, bytes}
    totalBytes int64
}

type sample struct {
    timestamp time.Time
    bytes     int64
}

// NewRateStats creates a new rate statistics tracker.
func NewRateStats(config RateStatsConfig) *RateStats

// Update adds a new byte count sample at the given time.
// Call this for each received packet with packet size.
func (r *RateStats) Update(bytes int64, now time.Time)

// Rate returns the current bitrate in bits per second.
// Returns (rate, true) if sufficient data exists, (0, false) otherwise.
// Requires at least 2 samples separated by >1ms to compute rate.
func (r *RateStats) Rate(now time.Time) (bitsPerSec int64, ok bool)

// Reset clears all samples and accumulated state.
func (r *RateStats) Reset()
```

Implementation details:
- Update() appends new sample, then removes samples older than windowSize
- Rate() computes: (totalBytes * 8) / elapsed.Seconds()
- Return ok=false if elapsed < 1ms (insufficient time) or no samples
- Use slice for samples (simpler than ring buffer for 1s window at typical packet rates)
- Default window: 1 second (matches libwebrtc RateStatistics)

Critical: Must handle packet gaps - if Update() called after >windowSize gap, all old samples should be removed.
  </action>
  <verify>
File exists with correct exports:
```bash
grep -E "^func|^type" pkg/bwe/rate_stats.go
```
Should show: RateStatsConfig, RateStats, NewRateStats, Update, Rate, Reset
  </verify>
  <done>RateStats type exists with sliding window implementation, correctly removes expired samples, computes bits-per-second rate</done>
</task>

<task type="auto">
  <name>Task 2: Create comprehensive unit tests for RateStats</name>
  <files>pkg/bwe/rate_stats_test.go</files>
  <action>
Create `pkg/bwe/rate_stats_test.go` with comprehensive tests.

Test cases to cover:

1. **TestRateStats_EmptyReturnsNotOk** - Rate() returns ok=false when no samples
2. **TestRateStats_SingleSampleReturnsNotOk** - Need at least 2 samples with time gap
3. **TestRateStats_BasicRate** - Add known bytes over known time, verify rate calculation
   - 1000 bytes over 1 second = 8000 bps
4. **TestRateStats_WindowSliding** - Old samples removed as window slides
   - Add samples at t=0, t=500ms, t=1.5s with 1s window
   - t=0 sample should be removed after t=1s query
5. **TestRateStats_GapHandling** - Handles gaps larger than window
   - Add sample at t=0, query at t=5s should return ok=false (all expired)
6. **TestRateStats_HighPacketRate** - Handles realistic packet rates
   - 30fps video at ~100KB/frame = ~3000 packets/s at MTU
   - Add 1000 samples, verify rate is stable
7. **TestRateStats_Reset** - Reset clears all state
8. **TestRateStats_ZeroBytes** - Handles zero-byte packets correctly

Use testify/assert for cleaner assertions.
Use table-driven tests where appropriate.

Example rate verification:
```go
// 125000 bytes over 1 second = 1 Mbps
r.Update(125000, t0)
r.Update(0, t0.Add(time.Second))
rate, ok := r.Rate(t0.Add(time.Second))
assert.True(t, ok)
assert.InDelta(t, 1_000_000, rate, 1000) // 1 Mbps +/- 1kbps tolerance
```
  </action>
  <verify>
```bash
cd /Users/thesyncim/GolandProjects/bwe && go test -v ./pkg/bwe/... -run TestRateStats
```
All tests pass.
  </verify>
  <done>All RateStats unit tests pass, covering edge cases (empty, single sample, window sliding, gaps, high packet rate, reset)</done>
</task>

</tasks>

<verification>
```bash
cd /Users/thesyncim/GolandProjects/bwe && go test -v ./pkg/bwe/... -run TestRateStats
```
All tests pass with clear output showing each test case.

```bash
cd /Users/thesyncim/GolandProjects/bwe && go build ./...
```
No compilation errors.
</verification>

<success_criteria>
- RateStats correctly measures bitrate: 125000 bytes/second = 1 Mbps
- Expired samples are removed when window slides
- Rate() returns ok=false for insufficient data
- All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-rate-control-remb/02-01-SUMMARY.md`
</output>
